# 架构设计文档

## 项目概述

Go 配置管理器是一个轻量级的配置中心库，基于 Viper 实现，提供配置文件管理、热更新、防抖处理等功能。采用模块化设计，支持高并发场景下的线程安全访问。

## 架构设计

### 核心架构

```
┌─────────────────────────────────────────────────────────────┐
│                    配置管理器架构                           │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │   API 层    │  │  业务逻辑层  │  │  数据访问层  │         │
│  │             │  │             │  │             │         │
│  │ - GetConfig │  │ - LoadConfig│  │ - Viper     │         │
│  │ - Default   │  │ - Monitor   │  │ - File I/O  │         │
│  │             │  │ - Validate  │  │             │         │
│  └─────┬───────┘  └─────┬───────┘  └─────┬───────┘         │
│        │               │               │                   │
│        └───────────────┼───────────────┘                   │
│                        │                                   │
│  ┌─────────────────────┴─────────────────────┐             │
│  │              核心管理器                     │             │
│  │  ┌─────────────┐  ┌─────────────┐        │             │
│  │  │   Manager   │  │   Config    │        │             │
│  │  │  - 单例模式   │  │  - 配置结构  │        │             │
│  │  │  - 线程安全   │  │  - 数据模型  │        │             │
│  │  │  - 生命周期   │  │  - 映射标签  │        │             │
│  │  └─────────────┘  └─────────────┘        │             │
│  └───────────────────────────────────────────┘             │
└─────────────────────────────────────────────────────────────┘
```

### 模块结构

```
config/
├── config.go              # 配置结构体定义
├── manager.go             # 核心管理器实现
├── get_config.go          # 配置获取接口
├── option.go              # 配置选项定义
├── const.go               # 默认常量
├── logger.go              # 日志钩子
├── hook.go                # 钩子机制
├── init_manager.go        # 管理器初始化
├── manager_file.go        # 文件操作
├── manager_update_field.go # 字段更新
├── monitor_config_changes.go # 配置监控
├── utils.go               # 工具函数
├── utils_manager.go       # 管理器工具
├── context.go             # 上下文管理
└── configure/
    └── m_app.go           # 应用配置模块
```

## 核心组件

### 1. 配置管理器 (Manager)

**职责：**
- 管理配置生命周期
- 提供线程安全的配置访问
- 处理配置文件加载和更新
- 实现防抖机制

**关键特性：**
- 单例模式确保全局唯一实例
- 读写锁保证并发安全
- 防抖机制避免频繁重载
- 支持自定义选项配置

```go
type Manager struct {
    config      *Config       // 配置对象
    vp          *viper.Viper  // Viper实例
    rwMutex     sync.RWMutex  // 读写锁
    lastChange  time.Time     // 防抖时间戳
    debounceDur time.Duration // 防抖间隔
    logger      *Logger       // 日志钩子
    opt         *Option       // 配置选项
}
```

### 2. 配置结构 (Config)

**职责：**
- 定义配置数据结构
- 提供类型安全的配置访问
- 支持结构体标签映射

**设计原则：**
- 清晰的结构体定义
- 完整的标签映射
- 支持嵌套结构

```go
type Config struct {
    App configure.App `mapstructure:"app"`
}
```

### 3. 配置选项 (Option)

**职责：**
- 提供灵活的配置选项
- 支持默认值设置
- 实现类型安全的选项管理

**特性：**
- 类型化选项定义
- 默认值自动初始化
- 线程安全的选项访问

```go
type Option struct {
    Filename    OptionString
    FileType    OptionString
    Path        OptionString
    Env         OptionString
    DebounceDur OptionTimeDuration
}
```

### 4. 文件监控 (Monitor)

**职责：**
- 监听配置文件变更
- 触发配置重载
- 实现防抖机制

**实现机制：**
- 基于 fsnotify 的文件系统监控
- 防抖算法避免频繁触发
- 异步处理避免阻塞主流程

## 数据流设计

### 配置加载流程

```
用户调用 LoadConfig()
        ↓
Manager 读取配置文件
        ↓
Viper 解析 YAML 内容
        ↓
结构体标签映射
        ↓
填充 Config 对象
        ↓
返回配置副本
```

### 热更新流程

```
文件系统变更事件
        ↓
Monitor 接收变更通知
        ↓
防抖检查（时间间隔）
        ↓
触发配置重载
        ↓
通知日志钩子
        ↓
更新全局配置
```

## 并发设计

### 线程安全机制

- **读写锁 (RWMutex)：** 保证配置访问的线程安全
- **原子操作：** 关键状态更新的原子性
- **防抖机制：** 避免并发场景下的重复加载

### 性能优化

- **配置副本：** 返回配置副本避免竞态条件
- **延迟加载：** 配置按需加载减少内存占用
- **缓存机制：** 防抖时间戳缓存避免重复检查

## 扩展设计

### 钩子机制

支持自定义日志钩子，便于集成现有日志系统：

```go
type Logger struct {
    hook func(string)
}
```

### 模块化配置

配置结构采用模块化设计，便于扩展新的配置类型：

```go
// 可扩展的配置模块
type App struct {
    Name        string `yaml:"name" mapstructure:"name"`
    Version     string `yaml:"version" mapstructure:"version"`
    Description string `yaml:"description" mapstructure:"description"`
}
```

## 错误处理

### 错误类型

- **文件错误：** 配置文件不存在或格式错误
- **解析错误：** YAML 解析失败或结构体映射错误
- **权限错误：** 文件读取权限不足
- **并发错误：** 读写锁获取失败

### 错误处理策略

- **快速失败：** 配置加载失败时立即返回错误
- **优雅降级：** 热更新失败时保持原有配置
- **日志记录：** 通过钩子机制记录错误信息

## 安全设计

### 数据安全

- **配置副本：** 避免直接暴露内部配置对象
- **只读访问：** 外部只能通过副本访问配置
- **类型安全：** 结构体定义确保类型正确性

### 文件安全

- **路径验证：** 配置文件路径安全检查
- **权限控制：** 文件读取权限验证
- **格式验证：** YAML 格式和内容验证

## 部署考虑

### 环境配置

支持不同环境的配置管理：

- **开发环境：** dev 配置，调试信息完整
- **测试环境：** test 配置，模拟生产环境
- **生产环境：** prod 配置，性能优化

### 监控建议

- **配置变更监控：** 记录配置变更历史
- **性能监控：** 监控配置加载时间和频率
- **错误监控：** 监控配置加载错误率

## 未来扩展

### 计划功能

- **多格式支持：** JSON、TOML 等格式支持
- **配置验证：** 结构体验证和约束检查
- **配置加密：** 敏感信息加密存储
- **分布式配置：** 支持远程配置中心

### 架构演进

- **插件化架构：** 支持自定义配置源
- **配置版本管理：** 支持配置版本回滚
- **灰度发布：** 支持配置灰度更新